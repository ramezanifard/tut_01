<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pycont.controller &#8212; Pycont 0.9.6 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.9.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="top" title="Pycont 0.9.6 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Pycont 0.9.6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pycont.controller</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. module:: controller</span>
<span class="sd">   :platform: Unix</span>
<span class="sd">   :synopsis: A module used for controlling the pumps.</span>

<span class="sd">.. moduleauthor:: Jonathan Grizou &lt;Jonathan.Grizou@gla.ac.uk&gt;</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">serial</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="kn">from</span> <span class="nn">._logger</span> <span class="k">import</span> <span class="n">create_logger</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">pump_protocol</span>

<span class="c">#: Represents the Broadcast of the C3000</span>
<span class="n">C3000Broadcast</span> <span class="o">=</span> <span class="s">&#39;_&#39;</span>

<span class="c">#: Switches the C3000 to a certain address</span>
<span class="n">C3000SwitchToAddress</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;0&#39;</span><span class="p">:</span> <span class="s">&#39;1&#39;</span><span class="p">,</span>
    <span class="s">&#39;1&#39;</span><span class="p">:</span> <span class="s">&#39;2&#39;</span><span class="p">,</span>
    <span class="s">&#39;2&#39;</span><span class="p">:</span> <span class="s">&#39;3&#39;</span><span class="p">,</span>
    <span class="s">&#39;3&#39;</span><span class="p">:</span> <span class="s">&#39;4&#39;</span><span class="p">,</span>
    <span class="s">&#39;4&#39;</span><span class="p">:</span> <span class="s">&#39;5&#39;</span><span class="p">,</span>
    <span class="s">&#39;5&#39;</span><span class="p">:</span> <span class="s">&#39;6&#39;</span><span class="p">,</span>
    <span class="s">&#39;6&#39;</span><span class="p">:</span> <span class="s">&#39;7&#39;</span><span class="p">,</span>
    <span class="s">&#39;7&#39;</span><span class="p">:</span> <span class="s">&#39;8&#39;</span><span class="p">,</span>
    <span class="s">&#39;8&#39;</span><span class="p">:</span> <span class="s">&#39;9&#39;</span><span class="p">,</span>
    <span class="s">&#39;9&#39;</span><span class="p">:</span> <span class="s">&#39;:&#39;</span><span class="p">,</span>
    <span class="s">&#39;A&#39;</span><span class="p">:</span> <span class="s">&#39;;&#39;</span><span class="p">,</span>
    <span class="s">&#39;B&#39;</span><span class="p">:</span> <span class="s">&#39;&lt;&#39;</span><span class="p">,</span>
    <span class="s">&#39;C&#39;</span><span class="p">:</span> <span class="s">&#39;=&#39;</span><span class="p">,</span>
    <span class="s">&#39;D&#39;</span><span class="p">:</span> <span class="s">&#39;&gt;&#39;</span><span class="p">,</span>
    <span class="s">&#39;E&#39;</span><span class="p">:</span> <span class="s">&#39;?&#39;</span><span class="p">,</span>
    <span class="s">&#39;BROADCAST&#39;</span><span class="p">:</span> <span class="n">C3000Broadcast</span><span class="p">,</span>
<span class="p">}</span>

<span class="c">#: Input for the valve</span>
<span class="n">VALVE_INPUT</span> <span class="o">=</span> <span class="s">&#39;I&#39;</span>
<span class="c">#: Output for the valve</span>
<span class="n">VALVE_OUTPUT</span> <span class="o">=</span> <span class="s">&#39;O&#39;</span>
<span class="c">#: Bypass for the valve</span>
<span class="n">VALVE_BYPASS</span> <span class="o">=</span> <span class="s">&#39;B&#39;</span>
<span class="c">#: Extra for the valve</span>
<span class="n">VALVE_EXTRA</span> <span class="o">=</span> <span class="s">&#39;E&#39;</span>

<span class="c">#: Microstep Mode 0</span>
<span class="n">MICRO_STEP_MODE_0</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c">#:Microstep Mode 2</span>
<span class="n">MICRO_STEP_MODE_2</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c">#: Number of steps in Microstep Mode 0</span>
<span class="n">N_STEP_MICRO_STEP_MODE_0</span> <span class="o">=</span> <span class="mi">3000</span>
<span class="c">#: Number of steps in Microstep Mode 2</span>
<span class="n">N_STEP_MICRO_STEP_MODE_2</span> <span class="o">=</span> <span class="mi">24000</span>

<span class="c">#: The maximum top velocity for Microstep Mode 0</span>
<span class="n">MAX_TOP_VELOCITY_MICRO_STEP_MODE_0</span> <span class="o">=</span> <span class="mi">6000</span>
<span class="c">#: The maximum top velocity for Microstep Mode 2</span>
<span class="n">MAX_TOP_VELOCITY_MICRO_STEP_MODE_2</span> <span class="o">=</span> <span class="mi">48000</span>

<span class="c">#: default Input/Output (I/O) Baudrate</span>
<span class="n">DEFAULT_IO_BAUDRATE</span> <span class="o">=</span> <span class="mi">9600</span>
<span class="c">#: Default timeout for I/O operations</span>
<span class="n">DEFAULT_IO_TIMEOUT</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c">#: Specifies a time to wait</span>
<span class="n">WAIT_SLEEP_TIME</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="c">#: Sets the maximum number of attempts to Write and Read</span>
<span class="n">MAX_REPEAT_WRITE_AND_READ</span> <span class="o">=</span> <span class="mi">10</span>
<span class="c">#: Sets the maximum time to repeat a specific operation</span>
<span class="n">MAX_REPEAT_OPERATION</span> <span class="o">=</span> <span class="mi">10</span>

<div class="viewcode-block" id="PumpIO"><a class="viewcode-back" href="../../pycont.html#pycont.controller.PumpIO">[docs]</a><span class="k">class</span> <span class="nc">PumpIO</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class deals with the pump I/O instructions.</span>

<span class="sd">    Args:</span>
<span class="sd">        port (int): The port number</span>

<span class="sd">        baudrate (int): Baudrate of the communication, default set to DEFAULT_IO_BAUDRATE(9600)</span>

<span class="sd">        timeout (int): The timeout of communication, default set to DEFAULT_IO_TIMEOUT(1)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="n">DEFAULT_IO_BAUDRATE</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">DEFAULT_IO_TIMEOUT</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">create_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baudrate</span> <span class="o">=</span> <span class="n">baudrate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">baudrate</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="PumpIO.from_config"><a class="viewcode-back" href="../../pycont.html#pycont.controller.PumpIO.from_config">[docs]</a>    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">io_config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets details laid out in the configuration .json file</span>

<span class="sd">        Args:</span>
<span class="sd">            cls (Class): The initialising class.</span>

<span class="sd">            io_config (Dict): Dictionary holding the configuration data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            PumpIO: New PumpIO object with the variables set from the configuration file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">io_config</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s">&#39;baudrate&#39;</span> <span class="ow">in</span> <span class="n">io_config</span><span class="p">:</span>
            <span class="n">baudrate</span> <span class="o">=</span> <span class="n">io_config</span><span class="p">[</span><span class="s">&#39;baudrate&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">baudrate</span> <span class="o">=</span> <span class="n">DEFAULT_IO_BAUDRATE</span>

        <span class="k">if</span> <span class="s">&#39;timeout&#39;</span> <span class="ow">in</span> <span class="n">io_config</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="n">io_config</span><span class="p">[</span><span class="s">&#39;timeout&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="n">DEFAULT_IO_TIMEOUT</span>

        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">baudrate</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="PumpIO.from_configfile"><a class="viewcode-back" href="../../pycont.html#pycont.controller.PumpIO.from_configfile">[docs]</a>    <span class="k">def</span> <span class="nf">from_configfile</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">io_configfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Opens the configuration file and parses the data to be used in the from_config method.</span>

<span class="sd">        Args:</span>
<span class="sd">            cls (Class): The initialising class.</span>

<span class="sd">            io_configfile (File): File which contains the configuration data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            PumpIO: New PumpIO object with the variables set form the configuration file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">io_configfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Closes the communication via close()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Closes the communication via close()</span>

<span class="sd">        Args:</span>
<span class="sd">            exc_type (Exception): The type of Exception.</span>

<span class="sd">            exc_value (Exception): The value associated with the Exception.</span>

<span class="sd">            traceback (str): Location of where the exception occured.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="PumpIO.open"><a class="viewcode-back" href="../../pycont.html#pycont.controller.PumpIO.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="n">DEFAULT_IO_BAUDRATE</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">DEFAULT_IO_TIMEOUT</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Opens a communication with the hardware.</span>

<span class="sd">        Args:</span>
<span class="sd">            port (int): The port number on which the communication will take place.</span>

<span class="sd">            baudrate (int): The baudrate of the communication, default set to DEFAULT_IO_BAUDRATE(9600).</span>

<span class="sd">            timeout (int): The timeout of the communication, default set to DEFAULT_IO_TIMEOUT(1).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_serial</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">baudrate</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Opening port &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
                          <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;port&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
                                 <span class="s">&#39;baudrate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">baudrate</span><span class="p">,</span>
                                 <span class="s">&#39;timeout&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">})</span></div>

<div class="viewcode-block" id="PumpIO.close"><a class="viewcode-back" href="../../pycont.html#pycont.controller.PumpIO.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Closes the communication with the hardware.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_serial</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Closing port &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
                          <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;port&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
                                 <span class="s">&#39;baudrate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">baudrate</span><span class="p">,</span>
                                 <span class="s">&#39;timeout&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">})</span></div>

<div class="viewcode-block" id="PumpIO.flushInput"><a class="viewcode-back" href="../../pycont.html#pycont.controller.PumpIO.flushInput">[docs]</a>    <span class="k">def</span> <span class="nf">flushInput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Flushes the input buffer of the serial communication.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_serial</span><span class="o">.</span><span class="n">flushInput</span><span class="p">()</span></div>

<div class="viewcode-block" id="PumpIO.write"><a class="viewcode-back" href="../../pycont.html#pycont.controller.PumpIO.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes a packet along the serial communication.</span>

<span class="sd">        Args:</span>
<span class="sd">            packet (DTInstructionPacket): The packet to send along the serial communication.</span>

<span class="sd">        .. note:: Unsure if this is the correct packet type (GAK).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">str_to_send</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Sending {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">str_to_send</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_serial</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_to_send</span><span class="p">)</span></div>

<div class="viewcode-block" id="PumpIO.readline"><a class="viewcode-back" href="../../pycont.html#pycont.controller.PumpIO.readline">[docs]</a>    <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads a line from the serial communication.</span>

<span class="sd">        Raises:</span>
<span class="sd">            PumpIOTimeOutError: If the response time is greater than the timeout threshold.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serial</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Received {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">msg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Readline timeout!&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">PumpIOTimeOutError</span></div>

    <span class="c">##</span>
<div class="viewcode-block" id="PumpIO.write_and_readline"><a class="viewcode-back" href="../../pycont.html#pycont.controller.PumpIO.write_and_readline">[docs]</a>    <span class="k">def</span> <span class="nf">write_and_readline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes a packet along the serial communication and waits for a response.</span>

<span class="sd">        Args:</span>
<span class="sd">            packet (DTInstructionPacket): The packet to be written.</span>

<span class="sd">        .. note:: Unsure if this is the correct packet type (GAK).</span>

<span class="sd">        Returns:</span>
<span class="sd">            reponse (str): The received response.</span>

<span class="sd">        Raises:</span>
<span class="sd">            PumpIOTimeOutError: If the response time is greater than the timeout threshold.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flushInput</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">except</span> <span class="n">PumpIOTimeOutError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">err</span></div></div>


<div class="viewcode-block" id="PumpIOTimeOutError"><a class="viewcode-back" href="../../pycont.html#pycont.controller.PumpIOTimeOutError">[docs]</a><span class="k">class</span> <span class="nc">PumpIOTimeOutError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception for when the response time is grerater than the timeout threshold.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="ControllerRepeatedError"><a class="viewcode-back" href="../../pycont.html#pycont.controller.ControllerRepeatedError">[docs]</a><span class="k">class</span> <span class="nc">ControllerRepeatedError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception for when there has been too many repeat attempts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="ControllerInitError"><a class="viewcode-back" href="../../pycont.html#pycont.controller.ControllerInitError">[docs]</a><span class="k">class</span> <span class="nc">ControllerInitError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception for when there is a failure in initialising the Controller.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="C3000Controller"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller">[docs]</a><span class="k">class</span> <span class="nc">C3000Controller</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class represents thhe main controller for the C3000.</span>
<span class="sd">    The controller is what controls the pumps.</span>

<span class="sd">    Args:</span>
<span class="sd">        pump_io (PumpIO): PumpIO object for communication.</span>

<span class="sd">        name (str): The name of the controller.</span>

<span class="sd">        address (str): Address of the controller.</span>

<span class="sd">        total_volume (int): Total volume of the pump.</span>

<span class="sd">        micro_step_mode (int): The mode which the microstep will use, default set to MICRO_STEP_MODE_2 (2)</span>

<span class="sd">        top_velocity (int): The top velocity of the pump, default set to 6000</span>

<span class="sd">        initialize_valve_position (chr): Sets the valve position, default set to VALVE_INPUT (&#39;I&#39;)</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: Invalid microstep mode.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pump_io</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">total_volume</span><span class="p">,</span> <span class="n">micro_step_mode</span><span class="o">=</span><span class="n">MICRO_STEP_MODE_2</span><span class="p">,</span> <span class="n">top_velocity</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span> <span class="n">initialize_valve_position</span><span class="o">=</span><span class="n">VALVE_INPUT</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">create_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_io</span> <span class="o">=</span> <span class="n">pump_io</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span> <span class="o">=</span> <span class="n">pump_protocol</span><span class="o">.</span><span class="n">C3000Protocol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_valve_position</span> <span class="o">=</span> <span class="n">initialize_valve_position</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">micro_step_mode</span> <span class="o">=</span> <span class="n">micro_step_mode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">micro_step_mode</span> <span class="o">==</span> <span class="n">MICRO_STEP_MODE_0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number_of_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">N_STEP_MICRO_STEP_MODE_0</span><span class="p">)</span>  <span class="c"># float</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">micro_step_mode</span> <span class="o">==</span> <span class="n">MICRO_STEP_MODE_2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number_of_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">N_STEP_MICRO_STEP_MODE_2</span><span class="p">)</span>  <span class="c"># float</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Microstep mode {} is not handled&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">micro_step_mode</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">total_volume</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">total_volume</span><span class="p">)</span>  <span class="c"># in ml (float)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps_per_ml</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_steps</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_volume</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">default_top_velocity</span> <span class="o">=</span> <span class="n">top_velocity</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="C3000Controller.from_config"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.from_config">[docs]</a>    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">pump_io</span><span class="p">,</span> <span class="n">pump_name</span><span class="p">,</span> <span class="n">pump_config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtains the configuration data.</span>

<span class="sd">        Args:</span>
<span class="sd">            cls (Class): The initialising class.</span>

<span class="sd">            pump_io (PumpIO): PumpIO object.</span>

<span class="sd">            pump_name (str): Name of the pump.</span>

<span class="sd">            pump_config (Dict): Dictionary containg the pump configurattion data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            C3000Controller: New C3000Controller object with the data set from the configuration.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pump_config</span><span class="p">[</span><span class="s">&#39;address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">C3000SwitchToAddress</span><span class="p">[</span><span class="n">pump_config</span><span class="p">[</span><span class="s">&#39;switch&#39;</span><span class="p">]]</span>
        <span class="k">del</span><span class="p">(</span><span class="n">pump_config</span><span class="p">[</span><span class="s">&#39;switch&#39;</span><span class="p">])</span>

        <span class="n">pump_config</span><span class="p">[</span><span class="s">&#39;total_volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pump_config</span><span class="p">[</span><span class="s">&#39;volume&#39;</span><span class="p">])</span>  <span class="c"># in ml (float)</span>
        <span class="k">del</span><span class="p">(</span><span class="n">pump_config</span><span class="p">[</span><span class="s">&#39;volume&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">pump_io</span><span class="p">,</span> <span class="n">pump_name</span><span class="p">,</span> <span class="o">**</span><span class="n">pump_config</span><span class="p">)</span></div>

    <span class="c">##</span>
<div class="viewcode-block" id="C3000Controller.write_and_read_from_pump"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.write_and_read_from_pump">[docs]</a>    <span class="k">def</span> <span class="nf">write_and_read_from_pump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="n">max_repeat</span><span class="o">=</span><span class="n">MAX_REPEAT_WRITE_AND_READ</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes packets to and reads the response from the pump.</span>

<span class="sd">        Args:</span>
<span class="sd">            packet (DTInstructionPacket): The packet to be written.</span>

<span class="sd">            max_repeat (int): The maximum time to repeat the read/write operation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            decoded_response (str): The decoded response.</span>

<span class="sd">        Raises:</span>
<span class="sd">            PumpIOTimeOutError: If the response itme is greater than the timeout threshold.</span>

<span class="sd">            ControllerRepeatedError: Error in decoding.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_repeat</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Write and read {}/{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_repeat</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io</span><span class="o">.</span><span class="n">write_and_readline</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
                <span class="n">decoded_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="o">.</span><span class="n">decode_packet</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">decoded_response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">decoded_response</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Decode error for {}, trying again!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">PumpIOTimeOutError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Timeout, trying again!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Too many failed communication!&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ControllerRepeatedError</span></div>

    <span class="c">##</span>
<div class="viewcode-block" id="C3000Controller.volume_to_step"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.volume_to_step">[docs]</a>    <span class="k">def</span> <span class="nf">volume_to_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume_in_ml</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines the number of steps for a given volume.</span>

<span class="sd">        Args:</span>
<span class="sd">            volume_in_ml (float): Volume in millilitres.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int(round(volume_in_ml * self.steps_per_ml))</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">volume_in_ml</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_per_ml</span><span class="p">))</span></div>

<div class="viewcode-block" id="C3000Controller.step_to_volume"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.step_to_volume">[docs]</a>    <span class="k">def</span> <span class="nf">step_to_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines the volume in a specific step.</span>

<span class="sd">        Args:</span>
<span class="sd">            step (int): Step number.</span>

<span class="sd">        Returns:</span>
<span class="sd">            step / float(self.steps_per_ml</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">step</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps_per_ml</span><span class="p">)</span></div>

    <span class="c">##</span>
<div class="viewcode-block" id="C3000Controller.is_idle"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.is_idle">[docs]</a>    <span class="k">def</span> <span class="nf">is_idle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines if the pump is idle or Busy</span>

<span class="sd">        Returns:</span>
<span class="sd">            True (bool): The pump is idle.</span>

<span class="sd">            False (bool): The pump is not idle.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: Value returned from the pump is not valid.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">report_status_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="o">.</span><span class="n">forge_report_status_packet</span><span class="p">()</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_and_read_from_pump</span><span class="p">(</span><span class="n">report_status_packet</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">pump_protocol</span><span class="o">.</span><span class="n">STATUS_IDLE_ERROR_FREE</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">True</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="n">pump_protocol</span><span class="o">.</span><span class="n">STATUS_BUSY_ERROR_FREE</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;The pump replied status {}, Not handled&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status</span><span class="p">))</span></div>

<div class="viewcode-block" id="C3000Controller.is_busy"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.is_busy">[docs]</a>    <span class="k">def</span> <span class="nf">is_busy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines if the pump is busy.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True (bool): Pump is busy.</span>

<span class="sd">            False (bool): Pump is idle.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: Value returned from the pump is not valid.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_idle</span><span class="p">()</span></div>

<div class="viewcode-block" id="C3000Controller.wait_until_idle"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.wait_until_idle">[docs]</a>    <span class="k">def</span> <span class="nf">wait_until_idle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Waits until the pump is not busy for WAIT_SLEEP_TIME, default set to 0.1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_busy</span><span class="p">():</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">WAIT_SLEEP_TIME</span><span class="p">)</span></div>

    <span class="c">##</span>
<div class="viewcode-block" id="C3000Controller.is_initialized"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.is_initialized">[docs]</a>    <span class="k">def</span> <span class="nf">is_initialized</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines if the pump has been initialised.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True (bool): The pump is initialised.</span>

<span class="sd">            False (bool): The pump is not initialised.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">initialized_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="o">.</span><span class="n">forge_report_initialized_packet</span><span class="p">()</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">init_status</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_and_read_from_pump</span><span class="p">(</span><span class="n">initialized_packet</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">init_status</span><span class="p">))</span></div>

<div class="viewcode-block" id="C3000Controller.smart_initialize"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.smart_initialize">[docs]</a>    <span class="k">def</span> <span class="nf">smart_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valve_position</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialises the pump and sets all pump parammeters.</span>

<span class="sd">        Args:</span>
<span class="sd">            valve_position (int): Position of the valve, default set None.</span>

<span class="sd">            secure (bool): Ensures that everything is correct, default set to True.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">valve_position</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_all_pump_parameters</span><span class="p">(</span><span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">)</span></div>

<div class="viewcode-block" id="C3000Controller.initialize"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valve_position</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">max_repeat</span><span class="o">=</span><span class="n">MAX_REPEAT_OPERATION</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialises the pump.</span>

<span class="sd">        Args:</span>
<span class="sd">            valve_position (int): Position of the valve, default set to None.</span>

<span class="sd">            max_repeat (int): Maximum number of times to repeat the operation, default set to MAX_REPEAT_OPERATION (10).</span>

<span class="sd">            secure (bool): Ensures that everything is correct.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ControllerRepeatedError: Too many failed attempts to initialise.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">valve_position</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">valve_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_valve_position</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_repeat</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">initialize_valve_only</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_valve_position</span><span class="p">(</span><span class="n">valve_position</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize_no_valve</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">():</span>
                <span class="k">return</span> <span class="k">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Too many failed attempts to initialize!&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ControllerRepeatedError</span></div>

<div class="viewcode-block" id="C3000Controller.initialize_valve_right"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.initialize_valve_right">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_valve_right</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operand_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialises the right valve.</span>

<span class="sd">        Args:</span>
<span class="sd">            operand_value (int): Value of the supplied operand.</span>

<span class="sd">            wait (bool): Whether or not to wait until the pump is idle, default set to True.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_and_read_from_pump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="o">.</span><span class="n">forge_initialize_valve_right_packet</span><span class="p">(</span><span class="n">operand_value</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait_until_idle</span><span class="p">()</span></div>

<div class="viewcode-block" id="C3000Controller.initialize_valve_left"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.initialize_valve_left">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_valve_left</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operand_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialises the left valve.</span>

<span class="sd">        Args:</span>
<span class="sd">            operand_value (int): Value of the supplied operand, default set to 0.</span>

<span class="sd">            wait (bool): Whether or not to wait until the pump is idle, default set to True.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_and_read_from_pump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="o">.</span><span class="n">forge_initialize_valve_right_packet</span><span class="p">(</span><span class="n">operand_value</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait_until_idle</span><span class="p">()</span></div>

<div class="viewcode-block" id="C3000Controller.initialize_no_valve"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.initialize_no_valve">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_no_valve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operand_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise with no valves.</span>

<span class="sd">        Args:</span>
<span class="sd">            operand_value (int): Value of the supplied operand.</span>

<span class="sd">            wait (bool): Whether or not to wait until the pump is idle, default set to True.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_and_read_from_pump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="o">.</span><span class="n">forge_initialize_no_valve_packet</span><span class="p">(</span><span class="n">operand_value</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait_until_idle</span><span class="p">()</span></div>

<div class="viewcode-block" id="C3000Controller.initialize_valve_only"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.initialize_valve_only">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_valve_only</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operand_string</span><span class="o">=</span><span class="s">&#39;0,0&#39;</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise with valves only.</span>

<span class="sd">        Args:</span>
<span class="sd">            operand_string (str): Value of the supplied operand.</span>

<span class="sd">            wait (bool): Whether or not to wait until the pump is idle, default set to True.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_and_read_from_pump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="o">.</span><span class="n">forge_initialize_valve_only_packet</span><span class="p">(</span><span class="n">operand_string</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait_until_idle</span><span class="p">()</span></div>

    <span class="c">##</span>
<div class="viewcode-block" id="C3000Controller.init_all_pump_parameters"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.init_all_pump_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">init_all_pump_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialises the pump parameters, Microstep Mode, and Top Velocity.</span>

<span class="sd">        Args:</span>
<span class="sd">            secure (bool): Ensures that everything is correct, default set to True.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_microstep_mode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">micro_step_mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_until_idle</span><span class="p">()</span>  <span class="c"># just in case, but should not be needed</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_top_velocity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_top_velocity</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_until_idle</span><span class="p">()</span>  <span class="c"># just in case, but should not be needed</span></div>

    <span class="c">##</span>
<div class="viewcode-block" id="C3000Controller.set_microstep_mode"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.set_microstep_mode">[docs]</a>    <span class="k">def</span> <span class="nf">set_microstep_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">micro_step_mode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the Microstep Mode to use.</span>

<span class="sd">        Args:</span>
<span class="sd">            micro_step_mode (int): Mode to use.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ControllerInitError: Attempting to set microstep mode before pump initialisation.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_and_read_from_pump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="o">.</span><span class="n">forge_microstep_mode_packet</span><span class="p">(</span><span class="n">micro_step_mode</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ControllerInitError</span><span class="p">(</span><span class="s">&#39;Pump should be initialized before set_microstep_mode&#39;</span><span class="p">)</span></div>

    <span class="c">##</span>
<div class="viewcode-block" id="C3000Controller.check_top_velocity_within_range"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.check_top_velocity_within_range">[docs]</a>    <span class="k">def</span> <span class="nf">check_top_velocity_within_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">top_velocity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks that the top velocity is within a maximum range.</span>

<span class="sd">        Args:</span>
<span class="sd">            top_velocity (int): The top velocity for the pump.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True (bool): Top velocity is within range.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: Top velocity is out of range.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">micro_step_mode</span> <span class="o">==</span> <span class="n">MICRO_STEP_MODE_0</span><span class="p">:</span>
            <span class="n">max_range</span> <span class="o">=</span> <span class="n">MAX_TOP_VELOCITY_MICRO_STEP_MODE_0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">micro_step_mode</span> <span class="o">==</span> <span class="n">MICRO_STEP_MODE_2</span><span class="p">:</span>
            <span class="n">max_range</span> <span class="o">=</span> <span class="n">MAX_TOP_VELOCITY_MICRO_STEP_MODE_2</span>

        <span class="k">if</span> <span class="n">top_velocity</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_range</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Top velocity {} is not in range&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">top_velocity</span><span class="p">))</span></div>

<div class="viewcode-block" id="C3000Controller.set_default_top_velocity"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.set_default_top_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">set_default_top_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">top_velocity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the default top velocity.</span>

<span class="sd">        Args:</span>
<span class="sd">            top_velocity (int): The top velocity for the pump.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_top_velocity_within_range</span><span class="p">(</span><span class="n">top_velocity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_top_velocity</span> <span class="o">=</span> <span class="n">top_velocity</span></div>

<div class="viewcode-block" id="C3000Controller.get_default_top_velocity"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.get_default_top_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">get_default_top_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the default top velocity.</span>

<span class="sd">        Returns:</span>
<span class="sd">            self.default_top_velocity (int): The default top velocity.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_top_velocity</span></div>

<div class="viewcode-block" id="C3000Controller.ensure_default_top_velocity"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.ensure_default_top_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">ensure_default_top_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensures that the top velocity is the default top velocity.</span>

<span class="sd">        Args:</span>
<span class="sd">            secure (bool): Ensures that everything is correct, default set to True.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_velocity</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_top_velocity</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_top_velocity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_top_velocity</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">)</span></div>

<div class="viewcode-block" id="C3000Controller.set_top_velocity"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.set_top_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">set_top_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">top_velocity</span><span class="p">,</span> <span class="n">max_repeat</span><span class="o">=</span><span class="n">MAX_REPEAT_OPERATION</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the top velocity for the pump.</span>

<span class="sd">        Args:</span>
<span class="sd">            top_velocity (int): The top velocity.</span>

<span class="sd">            max_repeat (int): Maximum number of times to repeat an operation, default set to MAX_REPEAT_OPERATION (10).</span>

<span class="sd">            secure (bool): Ensures that everything is correct.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True (bool): Top velocity has been set.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ControllerRepeatedError: Too many failed attempts at setting the top velocity.</span>

<span class="sd">            ControllerInitError: Attempting to set the top velocity befire the pump has been initialised.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_repeat</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_velocity</span><span class="p">()</span> <span class="o">==</span> <span class="n">top_velocity</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Top velocity not set, change attempt {}/{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_repeat</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_top_velocity_within_range</span><span class="p">(</span><span class="n">top_velocity</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_and_read_from_pump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="o">.</span><span class="n">forge_top_velocity_packet</span><span class="p">(</span><span class="n">top_velocity</span><span class="p">))</span>
                <span class="c"># if do not want to wait and check things went well, return now</span>
                <span class="k">if</span> <span class="n">secure</span> <span class="o">==</span> <span class="k">False</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">True</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Too many failed attempts in set_top_velocity!&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ControllerRepeatedError</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ControllerInitError</span><span class="p">(</span><span class="s">&#39;Pump should be initialized before set_top_velocity&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="C3000Controller.get_top_velocity"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.get_top_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">get_top_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the current top velocity.</span>

<span class="sd">        Returns:</span>
<span class="sd">            top_velocity (int): The current top velocity.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">top_velocity_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="o">.</span><span class="n">forge_report_peak_velocity_packet</span><span class="p">()</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">top_velocity</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_and_read_from_pump</span><span class="p">(</span><span class="n">top_velocity_packet</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">top_velocity</span><span class="p">)</span></div>

    <span class="c">##</span>
<div class="viewcode-block" id="C3000Controller.get_plunger_position"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.get_plunger_position">[docs]</a>    <span class="k">def</span> <span class="nf">get_plunger_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the current position of the plunger.</span>

<span class="sd">        Returns:</span>
<span class="sd">            steps (int): The position of the plunger.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plunger_position_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="o">.</span><span class="n">forge_report_plunger_position_packet</span><span class="p">()</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_and_read_from_pump</span><span class="p">(</span><span class="n">plunger_position_packet</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See get_plunger_position()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_plunger_position</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">remaining_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the remaining number of steps.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (int): self.number_of_steps - self.current_steps</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_steps</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_steps</span>

<div class="viewcode-block" id="C3000Controller.get_volume"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.get_volume">[docs]</a>    <span class="k">def</span> <span class="nf">get_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See step_to_volume()</span>

<span class="sd">        Returns:</span>
<span class="sd">            (float): self.step_to_volume(self.get_plunger_position())</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_to_volume</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_plunger_position</span><span class="p">())</span>  <span class="c"># in ml</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See get_volume()</span>

<span class="sd">        Returns:</span>
<span class="sd">            (float): self.get_volume()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_volume</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">remaining_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the remaining volume.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (float): self.total_volume - self.current_volume</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_volume</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_volume</span>

    <span class="c">##</span>
<div class="viewcode-block" id="C3000Controller.is_volume_pumpable"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.is_volume_pumpable">[docs]</a>    <span class="k">def</span> <span class="nf">is_volume_pumpable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume_in_ml</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines if the volume is pumpable.</span>

<span class="sd">        Args:</span>
<span class="sd">            volume_in_ml (float): The supplied volume.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True (bool): If the number of steps is &lt;= to the remaining steps.</span>

<span class="sd">            False (bool): The number of steps is &gt; than the remaining steps.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume_to_step</span><span class="p">(</span><span class="n">volume_in_ml</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">steps</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remaining_steps</span></div>

<div class="viewcode-block" id="C3000Controller.pump"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.pump">[docs]</a>    <span class="k">def</span> <span class="nf">pump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume_in_ml</span><span class="p">,</span> <span class="n">from_valve</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">speed_in</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the signal to initiate the pump sequence.</span>

<span class="sd">        .. warning:: Change of speed will last after the scope of this function but will be reset to default each time speed_in == None</span>

<span class="sd">        Args:</span>
<span class="sd">            volume_in_ml (float): Volume to pump (in mL).</span>

<span class="sd">            from_valve (chr): Pump using the valve, default set to None.</span>

<span class="sd">            speed_in (int): Speed to pump, default set to None.</span>

<span class="sd">            wait (bool): Waits for the pump to be idle, default set to False.</span>

<span class="sd">            secure (bool): Ensures everything is correct, default set to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True (bool): The supplied volume is pumpable.</span>

<span class="sd">            False (bool): Supplied volume is not pumpable.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_volume_pumpable</span><span class="p">(</span><span class="n">volume_in_ml</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">speed_in</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_top_velocity</span><span class="p">(</span><span class="n">speed_in</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ensure_default_top_velocity</span><span class="p">(</span><span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">from_valve</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_valve_position</span><span class="p">(</span><span class="n">from_valve</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">)</span>

            <span class="n">steps_to_pump</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume_to_step</span><span class="p">(</span><span class="n">volume_in_ml</span><span class="p">)</span>
            <span class="n">packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="o">.</span><span class="n">forge_pump_packet</span><span class="p">(</span><span class="n">steps_to_pump</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_and_read_from_pump</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wait_until_idle</span><span class="p">()</span>

            <span class="k">return</span> <span class="k">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">False</span></div>

    <span class="c">##</span>
<div class="viewcode-block" id="C3000Controller.is_volume_deliverable"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.is_volume_deliverable">[docs]</a>    <span class="k">def</span> <span class="nf">is_volume_deliverable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume_in_ml</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines if the supplied volume is deliverable.</span>

<span class="sd">        Args:</span>
<span class="sd">            volume_in_ml (float): The supplied volume in mL.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True (bool): The number of steps is &lt;= the current steps.</span>

<span class="sd">            False (bool): The number of steps is &gt; the current steps.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume_to_step</span><span class="p">(</span><span class="n">volume_in_ml</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">steps</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_steps</span></div>

<div class="viewcode-block" id="C3000Controller.deliver"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.deliver">[docs]</a>    <span class="k">def</span> <span class="nf">deliver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume_in_ml</span><span class="p">,</span> <span class="n">to_valve</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">speed_out</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delivers the volume payload.</span>

<span class="sd">        .. warning:: Change of speed will last after the scope of this function but will be reset to default each time speed_out == None</span>

<span class="sd">        Args:</span>
<span class="sd">            volume_in_ml (float): The supplied volume to deliver.</span>

<span class="sd">            to_valve (chr): The valve to deliver the payload to, default set to None.</span>

<span class="sd">            speed_out (int): The speed of delivery, default set to None.</span>

<span class="sd">            wait (bool): Waits for the pump to be idle, default set to False.</span>

<span class="sd">            secure (bool): Ensures that everything is correct, default set to False.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_volume_deliverable</span><span class="p">(</span><span class="n">volume_in_ml</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">speed_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_top_velocity</span><span class="p">(</span><span class="n">speed_out</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ensure_default_top_velocity</span><span class="p">(</span><span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">to_valve</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_valve_position</span><span class="p">(</span><span class="n">to_valve</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">)</span>

            <span class="n">steps_to_deliver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume_to_step</span><span class="p">(</span><span class="n">volume_in_ml</span><span class="p">)</span>
            <span class="n">packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="o">.</span><span class="n">forge_deliver_packet</span><span class="p">(</span><span class="n">steps_to_deliver</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_and_read_from_pump</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wait_until_idle</span><span class="p">()</span>

            <span class="k">return</span> <span class="k">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">False</span></div>

    <span class="c">##</span>
<div class="viewcode-block" id="C3000Controller.transfer"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.transfer">[docs]</a>    <span class="k">def</span> <span class="nf">transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume_in_ml</span><span class="p">,</span> <span class="n">from_valve</span><span class="p">,</span> <span class="n">to_valve</span><span class="p">,</span> <span class="n">speed_in</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">speed_out</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transfers the desired volume in mL.</span>

<span class="sd">        Args:</span>
<span class="sd">            volume_in_ml (float): The volume to transfer.</span>

<span class="sd">            from_valve (chr): The valve to transfer from.</span>

<span class="sd">            to_valve (chr): The valve to transfer to.</span>

<span class="sd">            speed_in (int): The speed of transfer to valve, default set to None.</span>

<span class="sd">            speed_out (int): The speed of transfer from the valve, default set to None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">volume_transfered</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">volume_in_ml</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remaining_volume</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pump</span><span class="p">(</span><span class="n">volume_transfered</span><span class="p">,</span> <span class="n">from_valve</span><span class="p">,</span> <span class="n">speed_in</span><span class="o">=</span><span class="n">speed_in</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deliver</span><span class="p">(</span><span class="n">volume_transfered</span><span class="p">,</span> <span class="n">to_valve</span><span class="p">,</span> <span class="n">speed_out</span><span class="o">=</span><span class="n">speed_out</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>

        <span class="n">remaining_volume_to_transfer</span> <span class="o">=</span> <span class="n">volume_in_ml</span> <span class="o">-</span> <span class="n">volume_transfered</span>
        <span class="k">if</span> <span class="n">remaining_volume_to_transfer</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span><span class="p">(</span><span class="n">remaining_volume_to_transfer</span><span class="p">,</span> <span class="n">from_valve</span><span class="p">,</span> <span class="n">to_valve</span><span class="p">,</span> <span class="n">speed_in</span><span class="p">,</span> <span class="n">speed_out</span><span class="p">)</span></div>

    <span class="c">##</span>
<div class="viewcode-block" id="C3000Controller.is_volume_valid"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.is_volume_valid">[docs]</a>    <span class="k">def</span> <span class="nf">is_volume_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume_in_ml</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines if the supplied volume is valid.</span>

<span class="sd">        Args:</span>
<span class="sd">            volume_in_ml (float): The supplied volume.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True (bool): The supplied volume is &lt;= the total volume and &gt;= 0</span>

<span class="sd">            False (bool): The supplied volume is &gt; total volume or &lt; 0</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">volume_in_ml</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_volume</span></div>

<div class="viewcode-block" id="C3000Controller.go_to_volume"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.go_to_volume">[docs]</a>    <span class="k">def</span> <span class="nf">go_to_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume_in_ml</span><span class="p">,</span> <span class="n">speed</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Moves the pump to the desired volume.</span>

<span class="sd">        .. warning:: Change of speed will last after the scope of this function but will be reset to default each time speed == None</span>

<span class="sd">        Args:</span>
<span class="sd">            volume_in_ml (float): The supplied volume.</span>

<span class="sd">            speed (int): The speed of movement, default set to None.</span>

<span class="sd">            wait (bool): Waits for the pump to be idle, defualt set to False.</span>

<span class="sd">            secure (bool): Ensures that everything is corect, default set to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True (bool): The supplied volume is valid.</span>

<span class="sd">            False (bool): THe supplied volume is not valid.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_volume_valid</span><span class="p">(</span><span class="n">volume_in_ml</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">speed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_top_velocity</span><span class="p">(</span><span class="n">speed</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ensure_default_top_velocity</span><span class="p">(</span><span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">)</span>

            <span class="n">steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume_to_step</span><span class="p">(</span><span class="n">volume_in_ml</span><span class="p">)</span>
            <span class="n">packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="o">.</span><span class="n">forge_move_to_packet</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_and_read_from_pump</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wait_until_idle</span><span class="p">()</span>

            <span class="k">return</span> <span class="k">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">False</span></div>

<div class="viewcode-block" id="C3000Controller.go_to_max_volume"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.go_to_max_volume">[docs]</a>    <span class="k">def</span> <span class="nf">go_to_max_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">speed</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Moves the pump to the maximum volume.</span>

<span class="sd">        Args:</span>
<span class="sd">            speed (int): The speed of movement, default set to None.</span>

<span class="sd">            wait (bool): Waits until the pump is idle, default set to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True (bool): The maximum volume is valid.</span>

<span class="sd">            False (bool): The maximum volume is not valid.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">go_to_volume</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_volume</span><span class="p">,</span> <span class="n">speed</span><span class="o">=</span><span class="n">speed</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">)</span></div>

    <span class="c"># valve</span>
<div class="viewcode-block" id="C3000Controller.get_raw_valve_position"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.get_raw_valve_position">[docs]</a>    <span class="k">def</span> <span class="nf">get_raw_valve_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the raw value of the valve&#39;s position.</span>

<span class="sd">        Returns:</span>
<span class="sd">            raw_valve_position (str): The raw position of the valve.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valve_position_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="o">.</span><span class="n">forge_report_valve_position_packet</span><span class="p">()</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">raw_valve_position</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_and_read_from_pump</span><span class="p">(</span><span class="n">valve_position_packet</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">raw_valve_position</span></div>

<div class="viewcode-block" id="C3000Controller.get_valve_position"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.get_valve_position">[docs]</a>    <span class="k">def</span> <span class="nf">get_valve_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_repeat</span><span class="o">=</span><span class="n">MAX_REPEAT_OPERATION</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the position of the valve.</span>

<span class="sd">        Args:</span>
<span class="sd">            max_repeat (int): The maximum number of times to repeat an operation, default set to MAX_REPEAT_OPERATION (10).</span>

<span class="sd">        Returns:</span>
<span class="sd">            (chr): The position of the valve.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: The valve position is not valid/unknown.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_repeat</span><span class="p">):</span>
            <span class="n">raw_valve_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_raw_valve_position</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">raw_valve_position</span> <span class="o">==</span> <span class="s">&#39;i&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">VALVE_INPUT</span>
            <span class="k">elif</span> <span class="n">raw_valve_position</span> <span class="o">==</span> <span class="s">&#39;o&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">VALVE_OUTPUT</span>
            <span class="k">elif</span> <span class="n">raw_valve_position</span> <span class="o">==</span> <span class="s">&#39;b&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">VALVE_BYPASS</span>
            <span class="k">elif</span> <span class="n">raw_valve_position</span> <span class="o">==</span> <span class="s">&#39;e&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">VALVE_EXTRA</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Valve position request failed attempt {}/{}, {} is unknown&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_repeat</span><span class="p">,</span> <span class="n">raw_valve_position</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Valve position received was {}. It is unknown&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">raw_valve_position</span><span class="p">))</span></div>

<div class="viewcode-block" id="C3000Controller.set_valve_position"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.set_valve_position">[docs]</a>    <span class="k">def</span> <span class="nf">set_valve_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valve_position</span><span class="p">,</span> <span class="n">max_repeat</span><span class="o">=</span><span class="n">MAX_REPEAT_OPERATION</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the position of the valve.</span>

<span class="sd">        Args:</span>
<span class="sd">            valve_position (str): Position of the valve.</span>

<span class="sd">            max_repeat (int): maximum number of times to repeat an operation, default set to MAX_REPEAT_OPERATION (10).</span>

<span class="sd">            secure (bool): Ensures that everything is correct, default set to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True (bool): The valve position has been set.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: The valve posiiton is invalid/unknown.</span>

<span class="sd">            ControllerRepeatedError: Too many failed attempts in set_top_velocity.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_repeat</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_valve_position</span><span class="p">()</span> <span class="o">==</span> <span class="n">valve_position</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Valve not in position, change attempt {}/{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_repeat</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">valve_position</span> <span class="o">==</span> <span class="n">VALVE_INPUT</span><span class="p">:</span>
                <span class="n">valve_position_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="o">.</span><span class="n">forge_valve_input_packet</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">valve_position</span> <span class="o">==</span> <span class="n">VALVE_OUTPUT</span><span class="p">:</span>
                <span class="n">valve_position_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="o">.</span><span class="n">forge_valve_output_packet</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">valve_position</span> <span class="o">==</span> <span class="n">VALVE_BYPASS</span><span class="p">:</span>
                <span class="n">valve_position_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="o">.</span><span class="n">forge_valve_bypass_packet</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">valve_position</span> <span class="o">==</span> <span class="n">VALVE_EXTRA</span><span class="p">:</span>
                <span class="n">valve_position_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="o">.</span><span class="n">forge_valve_extra_packet</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Valve position {} unknown&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">valve_position</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">write_and_read_from_pump</span><span class="p">(</span><span class="n">valve_position_packet</span><span class="p">)</span>

            <span class="c"># if do not want to wait and check things went well, return now</span>
            <span class="k">if</span> <span class="n">secure</span> <span class="o">==</span> <span class="k">False</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">True</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">wait_until_idle</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Too many failed attempts in set_top_velocity!&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ControllerRepeatedError</span></div>

<div class="viewcode-block" id="C3000Controller.set_eeprom_config"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.set_eeprom_config">[docs]</a>    <span class="k">def</span> <span class="nf">set_eeprom_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operand_value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the configuration of the EEPROM on the pumps.</span>

<span class="sd">        Args:</span>
<span class="sd">            operand_value (int): The value of the supplied operand.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">eeprom_config_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="o">.</span><span class="n">forge_eeprom_config_packet</span><span class="p">(</span><span class="n">operand_value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_and_read_from_pump</span><span class="p">(</span><span class="n">eeprom_config_packet</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">operand_value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;####################################################&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;3-Way Y-Valve: Connect jumper to pin 5 (bottom pin) below address switch at back of pump&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Unpower and repower the pump to activate changes!&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;####################################################&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;####################################################&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;Unpower and repower the pump to make changes active!&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&quot;####################################################&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="C3000Controller.flash_eeprom_3_way_y_valve"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.flash_eeprom_3_way_y_valve">[docs]</a>    <span class="k">def</span> <span class="nf">flash_eeprom_3_way_y_valve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See set_eeprom_config()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_eeprom_config</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="C3000Controller.flash_eeprom_3_way_t_valve"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.flash_eeprom_3_way_t_valve">[docs]</a>    <span class="k">def</span> <span class="nf">flash_eeprom_3_way_t_valve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See set_eeprom_config()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_eeprom_config</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span></div>

<div class="viewcode-block" id="C3000Controller.flash_eeprom_4_way_nondist_valve"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.flash_eeprom_4_way_nondist_valve">[docs]</a>    <span class="k">def</span> <span class="nf">flash_eeprom_4_way_nondist_valve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See set_eeprom_config()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_eeprom_config</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="C3000Controller.flash_eeprom_4_way_dist_valve"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.flash_eeprom_4_way_dist_valve">[docs]</a>    <span class="k">def</span> <span class="nf">flash_eeprom_4_way_dist_valve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See set_eeprom_config()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_eeprom_config</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span></div>

<div class="viewcode-block" id="C3000Controller.get_eeprom_config"><a class="viewcode-back" href="../../pycont.html#pycont.controller.C3000Controller.get_eeprom_config">[docs]</a>    <span class="k">def</span> <span class="nf">get_eeprom_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the EEPROM configuration.</span>

<span class="sd">        Returns:</span>
<span class="sd">            eeprom_config (int): The configuration of the EEPROM.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">eeprom_config</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_and_read_from_pump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="o">.</span><span class="n">forge_report_eeprom_packet</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">eeprom_config</span></div></div>


<div class="viewcode-block" id="MultiPumpController"><a class="viewcode-back" href="../../pycont.html#pycont.controller.MultiPumpController">[docs]</a><span class="k">class</span> <span class="nc">MultiPumpController</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class deals with controlling multiple pumps at a time.</span>

<span class="sd">    Args:</span>
<span class="sd">        setup_config (Dict): The configuration of the setup.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup_config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">create_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_io</span> <span class="o">=</span> <span class="n">PumpIO</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">setup_config</span><span class="p">[</span><span class="s">&#39;io&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s">&#39;default&#39;</span> <span class="ow">in</span> <span class="n">setup_config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_config</span> <span class="o">=</span> <span class="n">setup_config</span><span class="p">[</span><span class="s">&#39;default&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_config</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="s">&#39;groups&#39;</span> <span class="ow">in</span> <span class="n">setup_config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="n">setup_config</span><span class="p">[</span><span class="s">&#39;groups&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pumps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pump_name</span><span class="p">,</span> <span class="n">pump_config</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">setup_config</span><span class="p">[</span><span class="s">&#39;pumps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">defaulted_pump_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_pump_config</span><span class="p">(</span><span class="n">pump_config</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pumps</span><span class="p">[</span><span class="n">pump_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">C3000Controller</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_io</span><span class="p">,</span> <span class="n">pump_name</span><span class="p">,</span> <span class="n">defaulted_pump_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_pumps_as_attributes</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="MultiPumpController.from_configfile"><a class="viewcode-back" href="../../pycont.html#pycont.controller.MultiPumpController.from_configfile">[docs]</a>    <span class="k">def</span> <span class="nf">from_configfile</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">setup_configfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtains the configuration data from the supplied configuration file.</span>

<span class="sd">        Args:</span>
<span class="sd">            cls (Class): The initialising class.</span>

<span class="sd">            setup_configfile (File): The configuration file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            MultiPumpController: A new MultiPumpController object with the configuration set from the config file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">setup_configfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span></div>

<div class="viewcode-block" id="MultiPumpController.default_pump_config"><a class="viewcode-back" href="../../pycont.html#pycont.controller.MultiPumpController.default_pump_config">[docs]</a>    <span class="k">def</span> <span class="nf">default_pump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pump_config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a default pump configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            pump_config (Dict): Dictionary containing the pump configuration.</span>

<span class="sd">        Returns:</span>
<span class="sd">            defaulted_pump_config (Dict): A new defualt pump configuration mirroring that of pump_config.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">defaulted_pump_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_config</span><span class="p">)</span>  <span class="c"># make a copy</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pump_config</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">defaulted_pump_config</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">return</span> <span class="n">defaulted_pump_config</span></div>

<div class="viewcode-block" id="MultiPumpController.set_pumps_as_attributes"><a class="viewcode-back" href="../../pycont.html#pycont.controller.MultiPumpController.set_pumps_as_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">set_pumps_as_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the pumps as attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pump_name</span><span class="p">,</span> <span class="n">pump</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pumps</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pump_name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Pump named {pump_name} is already a reserved attribute, please change name or do not use this pump in attribute mode, rather use pumps[{pump_name}]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pump_name</span><span class="o">=</span><span class="n">pump_name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pump_name</span><span class="p">,</span> <span class="n">pump</span><span class="p">)</span></div>

<div class="viewcode-block" id="MultiPumpController.get_pumps"><a class="viewcode-back" href="../../pycont.html#pycont.controller.MultiPumpController.get_pumps">[docs]</a>    <span class="k">def</span> <span class="nf">get_pumps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pump_names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtains a list of all pumps.</span>

<span class="sd">        Args:</span>
<span class="sd">            pump_names (List): A list of the pump names</span>

<span class="sd">        Returns:</span>
<span class="sd">            pumps (List): A list of the pump names.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pumps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pump_name</span> <span class="ow">in</span> <span class="n">pump_names</span><span class="p">:</span>
            <span class="n">pumps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pumps</span><span class="p">[</span><span class="n">pump_name</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">pumps</span></div>

<div class="viewcode-block" id="MultiPumpController.apply_command_to_pumps"><a class="viewcode-back" href="../../pycont.html#pycont.controller.MultiPumpController.apply_command_to_pumps">[docs]</a>    <span class="k">def</span> <span class="nf">apply_command_to_pumps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pump_names</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies a given command to the pumps.</span>

<span class="sd">        Args:</span>
<span class="sd">            pump_names (List): List containing the pump names.</span>

<span class="sd">            command (str): The command to apply.</span>

<span class="sd">            *args: Variable length argument list.</span>

<span class="sd">            **kwargs: Arbitrary keyword arguements.</span>

<span class="sd">        Returns:</span>
<span class="sd">            returns (Dict): Dictionary of the functions.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pump_name</span> <span class="ow">in</span> <span class="n">pump_names</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pumps</span><span class="p">[</span><span class="n">pump_name</span><span class="p">],</span> <span class="n">command</span><span class="p">)</span>
            <span class="n">returns</span><span class="p">[</span><span class="n">pump_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">returns</span></div>

<div class="viewcode-block" id="MultiPumpController.apply_command_to_all_pumps"><a class="viewcode-back" href="../../pycont.html#pycont.controller.MultiPumpController.apply_command_to_all_pumps">[docs]</a>    <span class="k">def</span> <span class="nf">apply_command_to_all_pumps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies a given command to all of the pumps.</span>

<span class="sd">        Args:</span>
<span class="sd">            command (str): The command to apply.</span>

<span class="sd">            *args: Variable length argument list.</span>

<span class="sd">            **kwargs: Arbitrary keyword arguments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            returns (Dict): Dictionary of the functions.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_command_to_pumps</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pumps</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">command</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="MultiPumpController.apply_command_to_group"><a class="viewcode-back" href="../../pycont.html#pycont.controller.MultiPumpController.apply_command_to_group">[docs]</a>    <span class="k">def</span> <span class="nf">apply_command_to_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies a given command to the group.</span>

<span class="sd">        Args:</span>
<span class="sd">            group_name (str): Name of the group.</span>

<span class="sd">            command (str): The command to apply.</span>

<span class="sd">            *args: Variable length argument list.</span>

<span class="sd">            **kwargs: Arbitrary keyword arguements.</span>

<span class="sd">        Returns:</span>
<span class="sd">            returns (Dict) Dictionary of the functions.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_command_to_pumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">group_name</span><span class="p">],</span> <span class="n">command</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="c">##</span>
<div class="viewcode-block" id="MultiPumpController.are_pumps_initialized"><a class="viewcode-back" href="../../pycont.html#pycont.controller.MultiPumpController.are_pumps_initialized">[docs]</a>    <span class="k">def</span> <span class="nf">are_pumps_initialized</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines if the pumps have been initialised.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True (bool): The pumps have been initialised.</span>

<span class="sd">            False (bool): The pumps have not been initialised.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">pump</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pumps</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pump</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">():</span>
                <span class="k">return</span> <span class="k">False</span>
        <span class="k">return</span> <span class="k">True</span></div>

<div class="viewcode-block" id="MultiPumpController.smart_initialize"><a class="viewcode-back" href="../../pycont.html#pycont.controller.MultiPumpController.smart_initialize">[docs]</a>    <span class="k">def</span> <span class="nf">smart_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialises the pumps, setting all parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            secure (bool): Ensures everything is correct, default set to True.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">pump</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pumps</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pump</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">():</span>
                <span class="n">pump</span><span class="o">.</span><span class="n">initialize_valve_only</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="k">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_until_all_pumps_idle</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">pump</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pumps</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pump</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">():</span>
                <span class="n">pump</span><span class="o">.</span><span class="n">set_valve_position</span><span class="p">(</span><span class="n">pump</span><span class="o">.</span><span class="n">initialize_valve_position</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_until_all_pumps_idle</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">pump</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pumps</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pump</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">():</span>
                <span class="n">pump</span><span class="o">.</span><span class="n">initialize_no_valve</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="k">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_until_all_pumps_idle</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">apply_command_to_all_pumps</span><span class="p">(</span><span class="s">&#39;init_all_pump_parameters&#39;</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_until_all_pumps_idle</span><span class="p">()</span></div>

<div class="viewcode-block" id="MultiPumpController.wait_until_all_pumps_idle"><a class="viewcode-back" href="../../pycont.html#pycont.controller.MultiPumpController.wait_until_all_pumps_idle">[docs]</a>    <span class="k">def</span> <span class="nf">wait_until_all_pumps_idle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the command &#39;wait_until_idle&#39; to the pumps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_command_to_all_pumps</span><span class="p">(</span><span class="s">&#39;wait_until_idle&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MultiPumpController.are_pumps_idle"><a class="viewcode-back" href="../../pycont.html#pycont.controller.MultiPumpController.are_pumps_idle">[docs]</a>    <span class="k">def</span> <span class="nf">are_pumps_idle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines if the pumps are idle.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True (bool): The pumps are idle.</span>

<span class="sd">            False (bool): The pumps are not idle.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">pump</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pumps</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pump</span><span class="o">.</span><span class="n">is_idle</span><span class="p">():</span>
                <span class="k">return</span> <span class="k">False</span>
        <span class="k">return</span> <span class="k">True</span></div>

<div class="viewcode-block" id="MultiPumpController.are_pumps_busy"><a class="viewcode-back" href="../../pycont.html#pycont.controller.MultiPumpController.are_pumps_busy">[docs]</a>    <span class="k">def</span> <span class="nf">are_pumps_busy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines if the pumps are busy.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True (bool): The pumps are busy.</span>

<span class="sd">            False (bool): The pumps are not busy.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">are_pumps_idle</span><span class="p">()</span></div>

<div class="viewcode-block" id="MultiPumpController.pump"><a class="viewcode-back" href="../../pycont.html#pycont.controller.MultiPumpController.pump">[docs]</a>    <span class="k">def</span> <span class="nf">pump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pump_names</span><span class="p">,</span> <span class="n">volume_in_ml</span><span class="p">,</span> <span class="n">from_valve</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">speed_in</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pumps the desired volume.</span>

<span class="sd">        .. note:: Reimplemented as MultiPump so it is really synchronous</span>

<span class="sd">        Args:</span>
<span class="sd">            pump_names (List): The name of the pumps.</span>

<span class="sd">            volume_in_ml (float): The volume to be pumped.</span>

<span class="sd">            from_valve (chr): The valve to pump from.</span>

<span class="sd">            speed_in (int): The speed at which to pump, default set to None.</span>

<span class="sd">            wait (bool): Waits for the pumps to be idle, default set to False.</span>

<span class="sd">            secure (bool): Ensures everything is correct, default set to False.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">speed_in</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_command_to_pumps</span><span class="p">(</span><span class="n">pump_names</span><span class="p">,</span> <span class="s">&#39;set_top_velocity&#39;</span><span class="p">,</span> <span class="n">speed_in</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_command_to_pumps</span><span class="p">(</span><span class="n">pump_names</span><span class="p">,</span> <span class="s">&#39;ensure_default_top_velocity&#39;</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">from_valve</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_command_to_pumps</span><span class="p">(</span><span class="n">pump_names</span><span class="p">,</span> <span class="s">&#39;set_valve_position&#39;</span><span class="p">,</span> <span class="n">from_valve</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">apply_command_to_pumps</span><span class="p">(</span><span class="n">pump_names</span><span class="p">,</span> <span class="s">&#39;pump&#39;</span><span class="p">,</span> <span class="n">volume_in_ml</span><span class="p">,</span> <span class="n">speed_in</span><span class="o">=</span><span class="n">speed_in</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="k">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_command_to_pumps</span><span class="p">(</span><span class="n">pump_names</span><span class="p">,</span> <span class="s">&#39;wait_until_idle&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MultiPumpController.deliver"><a class="viewcode-back" href="../../pycont.html#pycont.controller.MultiPumpController.deliver">[docs]</a>    <span class="k">def</span> <span class="nf">deliver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pump_names</span><span class="p">,</span> <span class="n">volume_in_ml</span><span class="p">,</span> <span class="n">to_valve</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">speed_out</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delivers the desired volume.</span>

<span class="sd">        .. note:: Reimplemented as MultiPump so it is really synchronous</span>

<span class="sd">        Args:</span>
<span class="sd">            pump_names (List): The name of the pumps.</span>

<span class="sd">            volume_in_ml (float): The volume to be delivered.</span>

<span class="sd">            to_valve (chr): The valve to deliver to.</span>

<span class="sd">            speed_out (int): The speed at which to deliver.</span>

<span class="sd">            wait (bool): Wait for the pumps to be idle ,default set to False.</span>

<span class="sd">            secure (bool): Ensures everything is correct, default set to True.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">speed_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_command_to_pumps</span><span class="p">(</span><span class="n">pump_names</span><span class="p">,</span> <span class="s">&#39;set_top_velocity&#39;</span><span class="p">,</span> <span class="n">speed_out</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_command_to_pumps</span><span class="p">(</span><span class="n">pump_names</span><span class="p">,</span> <span class="s">&#39;ensure_default_top_velocity&#39;</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">to_valve</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_command_to_pumps</span><span class="p">(</span><span class="n">pump_names</span><span class="p">,</span> <span class="s">&#39;set_valve_position&#39;</span><span class="p">,</span> <span class="n">to_valve</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">apply_command_to_pumps</span><span class="p">(</span><span class="n">pump_names</span><span class="p">,</span> <span class="s">&#39;deliver&#39;</span><span class="p">,</span> <span class="n">volume_in_ml</span><span class="p">,</span> <span class="n">speed_out</span><span class="o">=</span><span class="n">speed_out</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="k">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_command_to_pumps</span><span class="p">(</span><span class="n">pump_names</span><span class="p">,</span> <span class="s">&#39;wait_until_idle&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MultiPumpController.transfer"><a class="viewcode-back" href="../../pycont.html#pycont.controller.MultiPumpController.transfer">[docs]</a>    <span class="k">def</span> <span class="nf">transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pump_names</span><span class="p">,</span> <span class="n">volume_in_ml</span><span class="p">,</span> <span class="n">from_valve</span><span class="p">,</span> <span class="n">to_valve</span><span class="p">,</span> <span class="n">speed_in</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">speed_out</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transfers the desired volume between pumps.</span>

<span class="sd">        .. note:: Reimplemented as MultiPump so it is really synchronous, needed</span>

<span class="sd">        Args:</span>
<span class="sd">            pump_names (List): The name of the pumps.</span>

<span class="sd">            volume_in_ml (float): The volume to be transfered.</span>

<span class="sd">            from_valve (chr): The valve to transfer from.</span>

<span class="sd">            to_valve (chr): the valve to transfer to.</span>

<span class="sd">            speed_in (int): The speed at which to receive transfer, default set to None.</span>

<span class="sd">            speed_out (int): The speed at which to transfer, default set to None</span>

<span class="sd">            secure (bool): Ensures that everything is correct, default set to False.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">volume_transfered</span> <span class="o">=</span> <span class="mi">1000000</span>  <span class="c"># some big number 1000L is more than any descent person will try</span>
        <span class="k">for</span> <span class="n">pump</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pumps</span><span class="p">(</span><span class="n">pump_names</span><span class="p">):</span>
            <span class="n">candidate_volume</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">volume_in_ml</span><span class="p">,</span> <span class="n">pump</span><span class="o">.</span><span class="n">remaining_volume</span><span class="p">)</span>
            <span class="n">volume_transfered</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">candidate_volume</span><span class="p">,</span> <span class="n">volume_transfered</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pump</span><span class="p">(</span><span class="n">pump_names</span><span class="p">,</span> <span class="n">volume_transfered</span><span class="p">,</span> <span class="n">from_valve</span><span class="p">,</span> <span class="n">speed_in</span><span class="o">=</span><span class="n">speed_in</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deliver</span><span class="p">(</span><span class="n">pump_names</span><span class="p">,</span> <span class="n">volume_transfered</span><span class="p">,</span> <span class="n">to_valve</span><span class="p">,</span> <span class="n">speed_out</span><span class="o">=</span><span class="n">speed_out</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">)</span>

        <span class="n">remaining_volume_to_transfer</span> <span class="o">=</span> <span class="n">volume_in_ml</span> <span class="o">-</span> <span class="n">volume_transfered</span>
        <span class="k">if</span> <span class="n">remaining_volume_to_transfer</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span><span class="p">(</span><span class="n">pump_names</span><span class="p">,</span> <span class="n">remaining_volume_to_transfer</span><span class="p">,</span> <span class="n">from_valve</span><span class="p">,</span> <span class="n">to_valve</span><span class="p">,</span> <span class="n">speed_in</span><span class="p">,</span> <span class="n">speed_out</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Pycont 0.9.6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Jonathan Grizou.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.8.
    </div>
  </body>
</html>